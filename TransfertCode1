
Sub Etape3()

    Dim derniereL As Integer
    Dim derniereC As Integer
    Dim compteur As Integer
    Dim i As Integer
    Dim j As Integer
    Dim tbl As ListObject
    Dim tbl_2 As ListObject
    Dim latest_date_actu As Date
    Dim latest_date_old As Date
    
    compteur = 0

    Set tbl = Sheets("1Current").ListObjects("Tableau_1Current")
    Set tbl_2 = Sheets("1.5Passage").ListObjects("Tableau_1.5Passage")
    
    derniereL = tbl.DataBodyRange.Rows.Count
    derniereC = tbl.DataBodyRange.Columns.Count
    
    latest_date_actu = LatestDate(Sheets("1Current"))
    latest_date_old = LatestDate(Sheets("1.5Passage"))

    For i = 1 To derniereL
        For j = 2 To derniereC - 7
            If tbl.DataBodyRange(i, j) <> tbl_2.DataBodyRange(i, j) Then
                tbl.DataBodyRange(i, j).Interior.ColorIndex = 6
                compteur = compteur + 1
            End If
        Next j
    Next i
    
    Call CalculerNoteMediane
    
    If latest_date_actu > latest_date_old Then
        If compteur > 0 Then
            MsgBox "Il y a eu " & compteur & " changements de ratings au total"
        End If
        Call VerifierTrigger(Sheets("1.5Passage"))
        Call ArchivageOnglet
        Call SupprimerPage(Sheets("2Previous"))
        Sheets("1.5Passage").Name = "2Previous"
        MsgBox "De nouvelles données sont disponibles. Archive effectuée" 'Phase de test
    ElseIf latest_date_actu = latest_date_old Then
        Call SupprimerPage(Sheets("1.5Passage"))
        Call VerifierTrigger(Sheets("2Previous"))
        MsgBox "Pas de nouvelles données"
    End If
        
End Sub
