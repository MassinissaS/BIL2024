Sub RatingsExternes3()

    Dim derniereL As Integer
    Dim derniereC As Integer
    Dim compteur As Integer
    Dim i As Integer
    Dim j As Integer
    Dim tbl As ListObject
    Dim tbl_2 As ListObject
    Dim eqty As Variant
    Dim derniereUpdate As String
    Dim currentMonth As String
    Dim currentYear As String
    Dim startPos As Integer
    Dim monthAndYear As String
    Dim monthName_old As String
    Dim yearValue_old As String
    Dim text As String
    
    ' Mise à jour de la date
    derniereUpdate = Format(Now(), "dd.mm.yyyy h:mm AM/PM")
    Sheets("1Current").Range("A1").Value = "Last update on : " & derniereUpdate
    Sheets("1Current").Range("A1").Interior.Color = RGB(165, 165, 165)
    Sheets("1Current").Range("A1").Font.Bold = True
    Sheets("1Current").Range("A1").Font.Size = 9
    
    ' Obtention du mois et de l'année en cours
    currentMonth = Format(Now(), "mmmm")
    currentYear = Year(Now())
    
    ' Extraction du mois et de l'année de la cellule C1 dans la feuille "1.5Passage"
    text = Sheets("1.5Passage").Range("C1").Value
    startPos = InStr(text, "of :") + Len("of :")
    monthAndYear = Trim(Mid(text, startPos))
    monthName_old = Split(monthAndYear)(0)
    yearValue_old = Split(monthAndYear)(1)
    
    ' Fusionner et centrer les cellules C1:D1
    With Sheets("1Current").Range("C1:D1")
        .Merge
        .HorizontalAlignment = xlCenter
        .Interior.Color = RGB(165, 165, 165)
        .BorderAround _
            ColorIndex:=1, Weight:=xlMedium
    End With
    
    ' Mise à jour de la cellule fusionnée avec le mois et l'année en cours
    Sheets("1Current").Cells(1, 3).Value = "The data concerns the month of : " & currentMonth & " " & currentYear
    
    compteur = 0

    ' Vérifier que les objets ListObject existent et sont correctement nommés
    On Error GoTo ErrorHandler
    Set tbl = Sheets("1Current").ListObjects("Tableau_1Current")
    Set tbl_2 = Sheets("1.5Passage").ListObjects("Tableau_1.5Passage")
    On Error GoTo 0
    
    ' Obtenir le nombre de lignes et de colonnes
    derniereL = tbl.DataBodyRange.Rows.Count
    derniereC = tbl.DataBodyRange.Columns.Count
    
    ' Comparaison des cellules et application de couleur jaune si différence
    For i = 1 To derniereL
        For j = 4 To derniereC - 2
            eqty = tbl.DataBodyRange(i, 3).Value
            If eqty > 5000000000# Or eqty = "-" Then
                tbl.DataBodyRange(i, 4).Value = "Framework 1"
            ElseIf eqty < 5000000000# Then
                tbl.DataBodyRange(i, 4).Value = "Framework 2"
            End If
            If tbl.DataBodyRange(i, j) <> tbl_2.DataBodyRange(i, j) Then
                tbl.DataBodyRange(i, j).Interior.ColorIndex = 6
                compteur = compteur + 1
            End If
        Next j
    Next i
    
    ' Calcul de la note médiane (sous-programme que vous devez avoir)
    Call CalculerNoteMediane
    
    ' Gestion des cas de changement de mois
    If currentMonth = monthName_old Then
        If compteur > 0 Then
            If compteur = 1 Then
                MsgBox "There was " & compteur & " rating change"
            Else
                MsgBox "There were " & compteur & " ratings changes"
            End If
        End If
        Call SupprimerPage(Sheets("1.5Previous"))
        Call TriggersRatings
        Call CompterTrigger
    Else
        ' Archivage de l'onglet "1.5Passage" (à implémenter)
    End If
    
    Exit Sub
    
ErrorHandler:
    MsgBox "Erreur: Vérifiez les objets ListObject ou d'autres références dans votre code.", vbCritical

End Sub
